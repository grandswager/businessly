<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Businessly</title>
    <script src="https://kit.fontawesome.com/e60f0fe32a.js" crossorigin="anonymous"></script>

    {% include "navbar.html" %}

    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>

<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
            <div class="alert {{ category }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endwith %}

    {% if user and user.type == "standard" %}
    <div class="dashboard-wrapper">
        <div class="dashboard-card">
            <div class="dashboard-header">
                <h2>Configure your Account</h2>
            </div>

            <div class="dashboard-grid">
                <!-- LEFT PROFILE -->
                <form id="avatarForm" action="/profile/avatar" method="POST" enctype="multipart/form-data">
                    <div class="profile-upload">
                        <label class="avatar-circle" for="avatarInput">
                            <img id="avatarPreview" alt="User avatar preview" src="{{ user.picture }}">
                            <div class="avatar-placeholder" id="avatarPlaceholder">
                                Click to change profile image
                            </div>
                        </label>

                        <input type="file" name="avatar" id="avatarInput" accept="image/png, image/jpeg" hidden/>

                        <small>JPG, PNG up to 5MB</small>
                    </div>
                </form>

                <!-- RIGHT FORM -->
                <form class="form" action="/dashboard/standard" method="POST">
                    <div class="field">
                        <input type="text" id="name" name="name" placeholder=" " value="{{ user.name }}">
                        <label for="name">Name</label>
                    </div>

                    <div class="field">
                        <select disabled>
                            <option value="standard" selected>Standard</option>
                            <option value="business">Business</option>
                        </select>
                        <label for="accountSelect">Account Type</label>
                    </div>

                    <div>
                        <p class="caption" style="margin-bottom: 0.2rem;">Categories</p>

                        <div class="category-grid">
                            {% for cat in ["Food", "Service", "Shop", "Health"] %}
                            <div class="category-chip {% if user.categories and cat in user.categories %}selected{% endif %}" onclick="toggleCategory(this)" data-value="{{ cat }}">
                                {{ cat }}
                            </div>
                            {% endfor %}
                        </div>

                        <div class="selected-categories" id="selectedCategories"></div>
                        <div id="hiddenInputs"></div>
                    </div>

                    <div class="button-row">
                        <button type="submit" class="btn primary" id="standardSave">Save Changes</button>
                        <button type="button" class="btn outline" onclick="resetForm()">Reset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="loading-backdrop" id="loadingBackdrop">
        <div class="loading-card">
            <div class="loading-spinner"></div>
            <p class="loading-text" id="loadingText">Loading...</p>
        </div>
    </div>

    <script>
        // -------- Avatar Upload --------
        const avatarInput = document.getElementById("avatarInput");
        const avatarPreview = document.getElementById("avatarPreview");
        const avatarPlaceholder = document.getElementById("avatarPlaceholder");
        const avatarForm = document.getElementById("avatarForm");
        const loadingBackdrop = document.getElementById("loadingBackdrop");
        const loadingText = document.getElementById("loadingText")

        avatarInput.addEventListener("change", function () {
            const file = this.files[0];
            if (!file) return;

            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = ["image/jpeg", "image/png"];

            if (file.size > maxSize) {
                alert("File too large. Max size is 5MB.");
                avatarInput.value = "";
                return;
            }

            if (!allowedTypes.includes(file.type)) {
                alert("Only JPG and PNG images are allowed.");
                avatarInput.value = "";
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                avatarPreview.src = e.target.result;
                avatarPreview.style.display = "block";
                avatarPlaceholder.style.display = "none";

                loadingBackdrop.classList.add("active");
                loadingText.innerText = "Uploading profile picture..."

                setTimeout(() => {
                    avatarForm.submit();
                }, 150);
            };

            reader.readAsDataURL(file);
        });

        // -------- Category Chips --------
        const selected = new Set({{ user.categories | tojson | safe }});
        renderSelected();

        function toggleCategory(el) {
            const value = el.dataset.value;

            if (selected.has(value)) {
                removeCategory(value);
                return;
            }

            if (selected.size >= 4) return;

            selected.add(value);
            el.classList.add("selected");
            renderSelected();
        }

        function removeCategory(value) {
            selected.delete(value);

            const chip = document.querySelector(
                `.category-chip[data-value="${value}"]`
            );
            if (chip) chip.classList.remove("selected");

            const selectedChip = document.querySelector(
                `.selected-chip[data-value="${value}"]`
            );

            if (selectedChip) {
                selectedChip.classList.add("removing");
                setTimeout(() => selectedChip.remove(), 200);
            }

            renderSelected();
        }

        function renderSelected() {
            const container = document.getElementById("selectedCategories");
            const hidden = document.getElementById("hiddenInputs");

            container.innerHTML = "";
            hidden.innerHTML = "";

            selected.forEach(cat => {
                const chip = document.createElement("div");
                chip.className = "selected-chip";
                chip.dataset.value = cat;
                chip.innerHTML = `
                ${cat}
                <span onclick="removeCategory('${cat}')">&times;</span>
                `;
                container.appendChild(chip);

                hidden.innerHTML += `
                <input type="hidden" name="categories" value="${cat}">
                `;
            });

            updateMutedState();
        }

        function updateMutedState() {
            const chips = document.querySelectorAll(".category-chip");

            chips.forEach(chip => {
                const value = chip.dataset.value;

                if (!selected.has(value) && selected.size >= 4) {
                    chip.classList.add("muted");
                } else {
                    chip.classList.remove("muted");
                }
            });
        }

        // -------- Reset --------
        function resetForm() {
            selected.clear();
            document.querySelectorAll(".category-chip").forEach(c => c.classList.remove("selected"));
            renderSelected();

            avatarPreview.style.display = "none";
            avatarPlaceholder.style.display = "block";
            avatarInput.value = "";
        }

        // Saving modal
        document.getElementById("standardSave").addEventListener("click", function () {
            loadingBackdrop.classList.add("active");
            loadingText.innerText = "Saving..."
        });
    </script>
    {% endif %}
</body>
</html>
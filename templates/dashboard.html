<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Businessly</title>
    <script src="https://kit.fontawesome.com/e60f0fe32a.js" crossorigin="anonymous"></script>

    {% include "navbar.html" %}

    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>

<body>
    {% if user and user.type == "standard" %}
    <div class="dashboard-wrapper">
        <div class="dashboard-card">

        <div class="dashboard-header">
            <h2>Configure your Account</h2>
        </div>

        <div class="dashboard-grid">
            
            <!-- LEFT PROFILE -->
            <div class="profile-upload">
                <label class="avatar-circle" for="avatarInput">
                    <img id="avatarPreview" alt="User avatar preview" src="{{ user.picture }}">
                    <div class="avatar-placeholder" id="avatarPlaceholder">Click to change profile image</div>
                </label>

                <input type="file" id="avatarInput" accept="image/*" hidden/>

                <small>JPG, PNG up to 5MB</small>
            </div>

            <!-- RIGHT FORM -->
            <form class="form">
            
            <div class="field">
                <input type="text" id="name" placeholder=" " value="{{ user.name }}">
                <label for="name">Name</label>
            </div>

            <div class="field">
                <input type="email" id="email" placeholder=" " value="{{ user.email }}" disabled>
                <label for="email">Email</label>
            </div>

            <div class="field">
                <select disabled>
                    <option value="standard" selected>Standard</option>
                    <option value="business">Business</option>
                </select>
                <label for="accountSelect">Account Type</label>
            </div>

            <div>
                <p class="caption" style="margin-bottom: 0.2rem;">Categories</p>

                <div class="category-grid">
                    {% for cat in ["Food", "Service", "Shop", "Health"] %}
                    <div class="category-chip {% if user.categories and cat in user.categories %}selected{% endif %}" onclick="toggleCategory(this)" data-value="{{ cat }}">
                        {{ cat }}
                    </div>
                    {% endfor %}
                </div>

                <div class="selected-categories" id="selectedCategories"></div>
                <div id="hiddenInputs"></div>
            </div>

            <div class="button-row">
                <button type="submit" class="btn primary">Save Changes</button>
                <button type="button" class="btn outline" onclick="resetForm()">Reset</button>
            </div>

            </form>
        </div>
        </div>
    </div>

  <script>
        // -------- Avatar Upload Preview --------
        const avatarInput = document.getElementById("avatarInput");
        const avatarPreview = document.getElementById("avatarPreview");
        const avatarPlaceholder = document.getElementById("avatarPlaceholder");

        avatarInput.addEventListener("change", function () {
            const file = this.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                avatarPreview.src = e.target.result;
                avatarPreview.style.display = "block";
                avatarPlaceholder.style.display = "none";
            };
            reader.readAsDataURL(file);
        });

        // -------- Category Chips --------
        const selected = new Set({{ user.categories | tojson | safe }});
        renderSelected();

        function toggleCategory(el) {
            const value = el.dataset.value;

            if (selected.has(value)) {
                removeCategory(value);
                return;
            }

            if (selected.size >= 4) return;

            selected.add(value);
            el.classList.add("selected");
            renderSelected();
        }

        function removeCategory(value) {
            selected.delete(value);

            const chip = document.querySelector(
                `.category-chip[data-value="${value}"]`
            );
            if (chip) chip.classList.remove("selected");

            const selectedChip = document.querySelector(
                `.selected-chip[data-value="${value}"]`
            );

            if (selectedChip) {
                selectedChip.classList.add("removing");
                setTimeout(() => selectedChip.remove(), 200);
            }

            renderSelected();
        }

        function renderSelected() {
            const container = document.getElementById("selectedCategories");
            const hidden = document.getElementById("hiddenInputs");

            container.innerHTML = "";
            hidden.innerHTML = "";

            selected.forEach(cat => {
                const chip = document.createElement("div");
                chip.className = "selected-chip";
                chip.dataset.value = cat;
                chip.innerHTML = `
                ${cat}
                <span onclick="removeCategory('${cat}')">&times;</span>
                `;
                container.appendChild(chip);

                hidden.innerHTML += `
                <input type="hidden" name="categories" value="${cat}">
                `;
            });

            updateMutedState();
        }

        function updateMutedState() {
            const chips = document.querySelectorAll(".category-chip");

            chips.forEach(chip => {
                const value = chip.dataset.value;

                if (!selected.has(value) && selected.size >= 4) {
                    chip.classList.add("muted");
                } else {
                    chip.classList.remove("muted");
                }
            });
        }

        // -------- Reset --------
        function resetForm() {
            selected.clear();
            document.querySelectorAll(".category-chip").forEach(c => c.classList.remove("selected"));
            renderSelected();

            avatarPreview.style.display = "none";
            avatarPlaceholder.style.display = "block";
            avatarInput.value = "";
        }
    </script>
    {% endif %}
</body>
</html>